<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../../../aeris-commons-components/dist/aeris-datepicker/aeris-datepicker.html">
<link rel="import" href="../../../aeris-commons-components/dist/behaviors/i18n/localizeBehavior.html">

<dom-module id="temporal-search-criteria">

  <style include="catalog-shared-styles">
    :host {
        display: block
    }
    :host .aeris-input-group {
        position: relative;
        overflow: visible
    }
    :host .aeris-input-group aeris-datepicker {
        position: absolute;
        top: 100%;
        left: 0
    }
    :host .error-message {
        font-size: 12px;
        color: red
    }
</style>
  </style>

  <template>

    <aeris-catalog-box id="box" title="[[_localize('temporalInterval', lang)]]" platform="fa fa-calendar">
      <div class="aeris-input-group">
    		<span>[[_localize('from_du', lang)]]</span>
        <input id="from" value="{{_from::input}}">
        <aeris-datepicker for="input#from" format$="[[format]]" selectors></aeris-datepicker>
    	</div>
    	<div class="aeris-input-group">
    		<span>[[_localize('to_au', lang)]]</span>
        <input id="to" value="{{_to::input}}">
        <aeris-datepicker for="input#to" format$="[[format]]" after="[[_from]]" selectors></aeris-datepicker>
    	</div>
      <span class="error-message">[[_errorMessage]]</span>
    </aeris-catalog-box>

  </template>

  <script>
    Polymer({

      is: 'temporal-search-criteria',

      behaviors: [LocalizeBehavior],

      properties: {
        format: {type: String, value: 'DD/MM/YYYY', reflectToAttribute: true},
        lang: {type: String, reflectToAttribute: true},
        _temporal: {type: Object, value: {}}
      },

      ready: function() {
        var el = document.querySelector('aeris-catalog-app');
        var parentLang = el.getAttribute('lang');
        this.lang = parentLang || navigator.language.substr(0, 2);

        document.addEventListener('dateSelected', function() {
          this._from = this.$.from.value;
          this._to = this.$.to.value;
          this.checkValidity();
        }.bind(this));

        this.$.from.addEventListener('blur', function() {
          this._from = this.$.from.value;
          this.checkValidity();
        }.bind(this));

        this.$.to.addEventListener('blur', function() {
          this._to = this.$.to.value;
          this.checkValidity();
        }.bind(this));

        document.addEventListener('searchBarResetEvent', this._handleSearchBarResetEvent.bind(this));
        document.addEventListener('searchBarSearchEvent', this._handleSearchBarSearchEvent.bind(this));
      },

      _handleSearchBarResetEvent: function() {
        this._from = '';
        this._to = '';
      },

      _handleSearchBarSearchEvent: function(e) {
        this._temporal = {};
        var from = moment(this.$.from.value, this.format);
        var to = moment(this.$.to.value, this.format);

        this._temporal.from = from.isValid() ? from.format('YYYY-MM-DD') : '';
        this._temporal.to = to.isValid() ? to.format('YYYY-MM-DD') : '';

        e.detail.temporal = this._temporal;
      },

      getValues: function() {
        return {
          from: this._temporal.from,
          to: this._temporal.to
        };
      },

      checkValidity: function() {
        var from = moment(this.$.from.value, this.format);
        var to = moment(this.$.to.value, this.format);

        if(from.isValid() && to.isValid() && to.isSameOrAfter(from)) {
          this._errorMessage = '';
          this.$.from.style.border = 'none';
          this.$.to.style.border = 'none';
        } else {
          if(this.$.from.value && !from.isValid()) {
            this.$.from.style.border = '2px solid red';
          }

          if(this.$.to.value && !to.isValid()) {
            this.$.to.style.border = '2px solid red';
          }
          
          if (this.$.from.value && this.$.to.value && to.isBefore(from)) {
            this._errorMessage = '"' + this.$.to.value + '" ' + this._localize('isBefore', this.lang) + ' "' + this.$.from.value + '"';
            this.$.to.style.border = '2px solid red';
          }
        }
      }

    });
  </script>

</dom-module>
