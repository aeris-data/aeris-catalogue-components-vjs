<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../aeris-catalog-bar/aeris-catalog-bar.html">
<link rel="import" href="../aeris-catalog-map/aeris-catalog-map.html">
<link rel="import" href="../aeris-catalog-search-bar/aeris-catalog-search-bar.html">
<link rel="import" href="../../../iron-ajax/iron-ajax.html">
<link rel="import" href="../aeris-collection-bar/aeris-collection-bar.html">
<link rel="import" href="../aeris-catalog-cart/aeris-catalog-cart.html">
<link rel="import" href="../aeris-catalog-box/aeris-catalog-box.html">
<link rel="import" href="../../../aeris-commons-components/dist/behaviors/i18n/localizeBehavior.html">
<link rel="import" href="../../../aeris-commons-components/dist/aeris-notifier/aeris-notifier.html">
<link rel="import" href="../../../aeris-commons-components/dist/imports/custom-scrollbar.html">
<link rel="import" href="../../../aeris-commons-components/dist/imports/sweet-alert.html">
<link rel="stylesheet" href="../../../sweetalert/dist/sweetalert.css">
<link rel="import" href="../styles/catalog-shared-styles.html">

<dom-module id="aeris-catalog-app">

 <style include="catalog-shared-styles">
    :host {
        box-sizing: border-box;
        position: relative;
        display: block;
        width: 100%;
        height: 100vh;
        margin: 0;
        font-family: 'Open Sans', sans-serif;
        line-height: 1.2;
        overflow: hidden
    }
    :host * {
        box-sizing: border-box
    }
    @keyframes pop {
        0% {
            transform: scale(1)
        }
        70% {
            transform: scale(1.2)
        }
        100% {
            transform: scale(1)
        }
    }
    :host aeris-catalog-bar,
    :host aeris-catalog-map,
    :host aeris-collection-bar {
        position: absolute;
        z-index: 10
    }
    :host aeris-catalog-bar,
    :host aeris-catalog-map,
    :host aeris-collection-bar {
        top: 0;
        height: 100vh
    }
    :host aeris-catalog-bar {
        left: 0;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3)
    }
    :host .search-criteria-content {
        position: relative;
        height: 100vh;
        padding-right: 10px;
        overflow: auto
    }
    :host aeris-catalog-map {
        left: 300px;
        width: calc(100% - 300px)
    }
    :host .catalog-search-button,
    :host .catalog-reset-button,
    :host .catalog-more-button,
    :host .catalog-collapse-button,
    :host .catalog-fullscreen-button,
    :host .catalog-help-button,
    :host .catalog-draw-button {
        box-sizing: border-box;
        display: flex;
        justify-content: center;
        align-items: center;
        position: absolute;
        z-index: 11;
        left: 10px;
        width: 50px;
        height: 50px;
        border: 2px solid;
        border-radius: 50%;
        color: #fff;
        font-size: 18px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        background-color: var(--search-button-color, #4765a0);
        transition: background-color 0.3s
    }
    :host .catalog-search-button:hover,
    :host .catalog-reset-button:hover,
    :host .catalog-more-button:hover,
    :host .catalog-collapse-button:hover,
    :host .catalog-fullscreen-button:hover,
    :host .catalog-help-button:hover,
    :host .catalog-draw-button:hover {
        cursor: pointer;
        background-color: var(--search-button-hover-color, #4765a0)
    }
    :host .catalog-search-button {
        top: 10px
    }
    :host .catalog-search-button .mask {
        display: none;
        cursor: initial
    }
    :host .catalog-search-button.disabled .mask {
        display: flex;
        justify-content: center;
        align-items: center;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(120, 120, 120, 0.8);
        border-radius: 50%
    }
    :host .catalog-reset-button {
        top: 70px
    }
    :host .catalog-more-button {
        top: 150px
    }
    :host .catalog-draw-button {
        top: 210px
    }
    :host .more-button:hover .catalog-collapse-button,
    :host .more-button:hover .catalog-fullscreen-button,
    :host .more-button:hover .catalog-help-button {
        z-index: 12;
        transform: translateY(0);
        transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0s, z-index 0s ease 0.3s
    }
    :host .catalog-collapse-button,
    :host .catalog-fullscreen-button,
    :host .catalog-help-button {
        z-index: 10;
        top: 160px;
        width: 25px;
        height: 25px;
        font-size: 12px;
        background-color: var(--search-button-color, #4765a0);
        transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.8s, background-color 0.3s
    }
    :host .catalog-collapse-button:hover,
    :host .catalog-fullscreen-button:hover,
    :host .catalog-help-button:hover {
        background-color: var(--search-button-hover-color, #4765a0);
        transform: translateX(0)
    }
    :host .catalog-collapse-button {
        left: 75px;
        transform: translateX(-50px)
    }
    :host .catalog-collapse-button:hover {
        transform: translateX(0)
    }
    :host .catalog-collapse-button i {
        transition: transform 0.3s
    }
    :host .catalog-collapse-button i.rotate {
        transform: rotate(180deg)
    }
    :host .catalog-help-button {
        left: 110px;
        transform: translateX(-85px)
    }
    :host .catalog-fullscreen-button {
        left: 145px;
        transform: translateX(-120px)
    }
    :host aeris-collection-bar {
        right: 0;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3)
    }
    :host .cart-bar {
        position: absolute;
        top: 0;
        right: 0;
        z-index: 12;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding: 0 10px;
        height: 40px;
        width: 300px;
        transition: 0.3s
    }
    :host .metadata-panel {
        box-sizing: border-box;
        position: absolute;
        z-index: 10;
        top: 5vh;
        right: 320px;
        width: 800px;
        min-width: 33vw;
        max-width: 80vw;
        height: calc(90vh - 130px);
        background-color: #fafafa;
        overflow: hidden;
        cursor: default;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
        transform: translate3d(calc(100% + 350px), 0, 0);
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1), width 0.3s ease-in-out 0.3s, height 0.3s ease-in-out 0.3s
    }
    :host .metadata-panel.expanded,
    :host .metadata-panel-content.expanded {
        transform: translate3d(0, 0, 0);
        opacity: 1
    }
    :host .metadata-panel.fullscreen {
        z-index: 12;
        width: 100vw;
        max-width: 100vw;
        height: 100%;
        transform: translate3d(320px, -5vh, 0)
    }
    :host .metadata-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px 0 10px;
        z-index: 2;
        border-bottom: 1px solid #ddd
    }
    :host .metadata-panel-header i {
        cursor: pointer;
        color: #888;
        opacity: 0.5
    }
    :host .metadata-panel-header i:hover {
        opacity: 1
    }
    :host .metadata-panel-header .metadata-panel-title {
        display: flex;
        align-items: center
    }
    :host .metadata-panel-header .metadata-panel-title h2 {
        display: inline;
        margin: 0 10px;
        padding: 5px 0
    }
    :host .metadata-panel-content {
        max-height: calc(100% - 90px);
        padding: 10px 10px 60px 10px;
        overflow-y: auto;
        overflow-x: hidden;
        opacity: 0;
        transform: translate3d(100%, 0, 0);
        transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1) 0s
    }
    :host .metadata-panel-footer {
        position: absolute;
        bottom: 0;
        box-sizing: border-box;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 50px;
        border-top: 1px solid #ddd;
        background-color: #fafafa
    }
    :host .metadata-panel-footer .metadata-footer-icon {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 30px;
        height: 30px;
        margin: 0 5px;
        border: 1px solid;
        border-radius: 50%;
        color: #bbb;
        cursor: pointer;
        transform: scale(1)
    }
    :host .metadata-panel-footer .metadata-footer-icon:hover {
        animation-name: pop;
        animation-duration: 0.3s
    }
    @media screen and (max-height: 800px) {
        :host aeris-catalog-bar,
        :host aeris-catalog-map,
        :host aeris-collection-bar {
            top: 0;
            height: 100vh
        }
        :host .search-criteria-content {
            height: 100vh
        }
        :host .metadata-panel {
            height: calc(90vh - 60px)
        }
    }
</style>
  <template>
    <iron-ajax id="ajax"
                 url=""
                 params=""
                 handle-as="json"
                 on-response="_handleResponse"
                 on-error="_handleError"
                 debounce-duration="300"
                 headers='{"cache-control": "max-age=10"}'>
    </iron-ajax>

    <div class="app-container">

      <aeris-notifier></aeris-notifier>

      <aeris-catalog-bar lang$="[[lang]]">
        <div class="search-criteria-content">
          <content select=".criteria"></content>
        </div>
      </aeris-catalog-bar>

      <aeris-catalog-map service="[[mapService]]" metadata-service="[[metadataIdService]]" area="[[area]]" lang$="[[lang]]">
        <div class="map-rounded-button catalog-search-button tooltip" data-popup="right" data-title$="[[_localize('search', lang)]]" on-click="_handleSearch">
          <div class="mask">
            <i class="fa fa-circle-o-notch fa-spin fa-fw"></i>
          </div>
          <i class="fa fa-search"></i>
        </div>
        <div class="map-rounded-button catalog-reset-button tooltip" data-popup="right" data-title$="[[_localize('clear', lang)]]" on-click="_handleReset">
          <i class="fa fa-times"></i>
        </div>
        <div class="more-button">
          <div class="map-rounded-button catalog-more-button">
            <i class="fa fa-ellipsis-h"></i>
          </div>
          <div class="map-rounded-button catalog-collapse-button tooltip" data-popup="bottom" data-title$="[[_localize('expand_collapse_all', lang)]]" on-click="_handleCollapse">
            <i class="fa fa-chevron-up"></i>
          </div>
          <div class="map-rounded-button catalog-help-button tooltip" data-popup="bottom" data-title$="[[_localize('help', lang)]]" on-click="_showHelp">
            <i class="fa fa-question"></i>
          </div>
          <div class="map-rounded-button catalog-fullscreen-button tooltip" data-popup="bottom" data-title$="[[_localize('fullscreen', lang)]]" on-click="_toggleFullScreen">
            <i class="fa fa-expand"></i>
          </div>
        </div>
        <template is="dom-if" if="[[!noDrawOnMap]]">
          <div class="map-rounded-button catalog-draw-button tooltip" data-popup="right" data-title$="[[_localize('draw', lang)]]" on-click="_handleDraw">
            <i class="fa fa-pencil-square-o"></i>
          </div>
        </template>
      </aeris-catalog-map>

      <aeris-collection-bar lang$="[[lang]]"></aeris-collection-bar>
      <div class="cart-bar">
        <aeris-catalog-cart service="[[cartService]]" hidden$="[[!_isCartVisible]]" lang$="[[lang]]"></aeris-catalog-cart>
      </div>

      <aside id="metadataPanel" class="metadata-panel">
        <navigation class="metadata-panel-header">
          <span class="metadata-panel-title">
            <h2>
              <aeris-metadata-international-field value="[[_metadataTitle]]" lang$="[[lang]]" no-label-float></aeris-metadata-international-field>
            </h2>
          </span>
          <i class="fa fa-times" on-click="_collapseMetadataPanel"></i>
        </navigation>
        <div id="metadataPanelContent" class="metadata-panel-content">
          <content select=":not(.criteria)"></content>
        </div>
        <footer class="metadata-panel-footer">
          <i class="fa fa-arrow-left metadata-footer-icon" on-click="_previous" title="[[_localize('previous', lang)]]"></i>
          <i class$="fa [[_expandIcon]] metadata-footer-icon" on-click="_setMetadataPanelFullscreen" title="[[_localize('fullscreen', lang)]]"></i>
          <i class="fa fa-times metadata-footer-icon" on-click="_collapseMetadataPanel" title="[[_localize('close', lang)]]"></i>
          <i class="fa fa-print metadata-footer-icon" on-click="_printMetadatas" title="[[_localize('print', lang)]]"></i>
          <i class="fa fa-code metadata-footer-icon" on-click="_showJson" title="[[_localize('showJson', lang)]]"></i>
          <i class="fa fa-arrow-right metadata-footer-icon" on-click="_next" title="[[_localize('next', lang)]]"></i>
        </footer>
      </aside>

    </div>
  </template>

  <script>

    Polymer({

      is: 'aeris-catalog-app',

      behaviors: [LocalizeBehavior],

      properties: {
        /* Cart service */
        cartService: String,

        /* Web service for metadatas */
        metadataService: {type: String, reflectToAttribute: true},

        /* Optional. Same as above (For metadatas by id) */
        metadataIdService: {type: String, reflectToAttribute: true},

        /* Component language */
        lang: {type: String, reflectToAttribute: true, observer: '_updateLang'},

        /* Optional. If set, hide the "toggle to fullscreen" button */
        noFullscreen: {type: Boolean, value: false},

        /* No 'draw' button on the map */
        noDrawOnMap: {type: Boolean, value: false},

        /* Limit catalog to only one program (program = <programName>) */
        program: String,

        /* Define a starting area on the map */
        area: {type: String, value: ''},

        /* Private properties */
        _expandIcon: {type: String, value: 'fa-expand'},
        _isCartVisible: {type: Boolean, value: true},
        _cardsDeployed: {type: Boolean, value: true},
        _lock: {type: Boolean, value: false}
      },

      ready: function() {
        var _this = this;

        /* Get the JSON url for later display */
        document.addEventListener('MetadataJsonUrl', function(e) {
          this.metadataJsonUrl = e.detail;
        }.bind(this));

        /* Toggle fullscreen for the entire application */
        document.addEventListener('ToggleAppFullScreen', this._toggleFullScreen.bind(this));

        /* When search button is pressed */
        document.addEventListener('searchBarSearchEvent', this._collapseMetadataPanel.bind(this));

        /* When results are found */
        document.addEventListener('searchResultEvent', this._storeResultsIds.bind(this));

        /* When "more" button is pressed on a search result */
        document.addEventListener('showMetadataPanel', this._expandMetadataPanel.bind(this));

        /* When reset button is pressed */
        document.addEventListener('searchBarResetEvent', this._collapseMetadataPanel.bind(this));

        /* On cart checkout */
        document.addEventListener('dataOrder', this._orderData.bind(this));

        /* Clean url and create the services urls */
        if(this.metadataService.endsWith('/')) this.metadataService = this.metadataService.substring(0, this.metadataService.length - 1);

        this.mapService = this.metadataService + '/request';
        this.metadataIdService = this.metadataService + '/id/';

        /* Catch HTTP requests and add 'program' to parameters if defined */
        (function(open) {

          XMLHttpRequest.prototype.open = function(method, url, async, user, pass) {
            var separator = url.match(/\?/) ? '&' : '?';
            url = _this.program ? url + separator + 'program=' + _this.program : url;

            open.call(this, method, url, async, user, pass);
          };

        })(XMLHttpRequest.prototype.open);

        /* Get language for the application */
        this._updateLang();
      },

      attached: function() {
        /* Register the metadata panel element for later use */
        this.metadataPanel = Polymer.dom(this.root).querySelector('#metadataPanel');
        this.metadataPanelContent = this.metadataPanel.querySelector('.metadata-panel-content');

        /* Initialise custom scrollbar, focus the first input and create metadata element */
        window.setTimeout(function() {
          var el = Polymer.dom(this.root).querySelector('.search-criteria-content');
          this._initCustomScrollbar(el);

          window.setTimeout(function() {
            var el = Polymer.dom(this.root).querySelector('.search-criteria-content');
            this._initCustomScrollbar(el);
          }.bind(this), 500);

          var input = document.querySelector('input');
          input.focus();
        }.bind(this), 500);

        /* Set metadata component attributes */
        this.mdDomElement = document.querySelector('aeris-metadata');
        this.mdDomElement.setAttribute('service', this.metadataIdService);
        this.mdDomElement.setAttribute('lang', this.lang);
        this._initCustomScrollbar(this.metadataPanelContent);

        this._getUrlParameters();

        if(this.urlParameters.uuid) {
          var fakeEvent = {
            detail: {
              id: this.urlParameters.uuid,
              title: ''
            }
          };

          this._expandMetadataPanel(fakeEvent);
        }

        this.mdDomElement.addEventListener('dataReceived', function(e) {
          this._metadataTitle = e.detail.data.resourceTitle[this.lang] || e.detail.data.resourceTitle.fr;
          if(e.detail.data.resourceTitle.DEFAULT_VALUE_KEY) this._metadataTitle = e.detail.data.resourceTitle.DEFAULT_VALUE_KEY;
          var type = e.detail.data.type;

          if(type) {
            var suffix = type.toLowerCase();
            this.mdDomElement.innerHTML = '<md-template-' + suffix + '></md-template-' + suffix + '>';
          }
          
        }.bind(this));

        this.fire('catalogAppLoaded');
      },

      _getUrlParameters: function() {
        var _this = this;
        var url = window.location.href;
        var hashIndex = url.indexOf('#');
        var urlParamsString = (hashIndex < 0) ? '' : url.substring(hashIndex + 1, url.length);
        var urlParamsArr = urlParamsString.split(';');
        this.urlParameters = {};

        urlParamsArr.forEach(function(item) {
          var arr = item.split(':');
          if(arr[0]) this.urlParameters[arr[0]] = arr[1];
        }.bind(this));
      },

      _removeUrlParameters: function(param) {
        var _this = this;
        var paramsStr;
        var simpleUrl = window.location.href.substring(0, window.location.href.indexOf('#'));
        this._getUrlParameters();
        if(!this.urlParameters[param]) return;

        delete this.urlParameters[param];
        for (var key in this.urlParameters) {
          if (!this.urlParameters.hasOwnProperty(key)) continue;
          paramsStr = paramsStr + ';' + _this.urlParameters[key]
        }

        var newUrl = paramsStr ? simpleUrl + '#' + paramsStr : simpleUrl;
        window.history.replaceState({} , '', newUrl);
      },

      /* Get language from attribute or browser preferences */
      _updateLang: function() {
        this.lang = this.lang || navigator.language.substr(0, 2);
      },

      /* Handle event when click on 'draw' button */
      _handleDraw: function() {
        var editIcon = document.querySelector('.spatial-edit-button i');
        var eventName = editIcon.style.color ? 'mapEditStopEvent' : 'mapEditStartEvent';
        this.fire(eventName, editIcon);
      },

      _handleReset: function() {
        this.fire('searchBarResetEvent');
      },

      _handleSearch: function() {
        if(!this._lock) { /* Lock is a cooldown */
          this._lockSearch(true);
          var searchEvent = {};

          /* Collect request parameters */
          this.fire('searchBarSearchEvent', searchEvent);

          /* Send the metadata request */
          this.fire('metadataRequest', searchEvent);
        }
      },

      /* Create cooldown for 'search' button */
      _lockSearch: function(flag) {
        const COOLDOWN_TIME = 10000; /* Maximal time before re-enabling 'search' button */
        var searchButton = Polymer.dom(this.root).querySelector('.catalog-search-button');

        if(flag) {
          this._lock = true;
          this._lockTimeout = window.setTimeout(function() {
            this._lockSearch(false);
          }.bind(this), COOLDOWN_TIME);
          searchButton.classList.add('disabled');
        } else {
          window.setTimeout(function() {
            this._lock = false;
            if(this._lockTimeout) window.clearTimeout(this._lockTimeout);
            searchButton.classList.remove('disabled');
          }.bind(this), 800); /* 800 is the minimal time to avoid bugs due to asynchronous calls */
        }
      },

      /* Handle cards collapsing when clicking on the map menu button */
      _handleCollapse: function(e) {
        var el = e.target;
        if(el.nodeName !== 'I') el = el.children[0];
        el.classList.toggle('rotate');
        var eventName = this._cardsDeployed ? 'collapseCards' : 'deployCards';
        this.fire(eventName);
        this._cardsDeployed = !this._cardsDeployed;
      },

      /* Store search results for later use */
      _storeResultsIds: function(e) {
        this._lockSearch(false);
        this._resultsIds = [];
        var summaries = e.detail.summaries;
        summaries.forEach(function(summary) {
          this.push('_resultsIds', summary);
        }.bind(this));
      },

      /* Handle click on the previous or next arrows in the metadata sheet (stepRange is an integer: 1||-1) */
      _step: function(stepRange) {
        var index;
        var metadata = this.metadataPanel.querySelector('aeris-metadata');
        var currentId = metadata.getAttribute('identifier');
        this._resultsIds.forEach(function(item) {
          if(item.id === currentId) {
            index = this._resultsIds.indexOf(item);
            return;
          }
        }.bind(this));

        var aux = index + stepRange;
        var fakeEvent;
        if(aux < 0 || aux > this._resultsIds.length - 1) {
          return false;
        } else {
          var newMd = this._resultsIds[index + stepRange];
          fakeEvent = {
            detail: {
              id: newMd.id,
              title: newMd.title
            }
          };
        }

        this._expandMetadataPanel(fakeEvent);
      },

      _next: function() {
        this._step(1);
      },

      _previous: function() {
        this._step(-1);
      },

      /* Initialise Perfect Scrollbar on the given DOM element */
      _initCustomScrollbar: function(element) {
        Ps.destroy(element);
        window.setTimeout(function() {
          Ps.initialize(element, {
            suppressScrollX: true
          });

          /* Scrolls to make scrollbar visible */
          element.scrollTop = 1;
          element.scrollTop = 0;
        }.bind(this), 300); /* Timeout to let time for informations to load */
      },

      /* Expand the metadata panel */
      _expandMetadataPanel: function(e) {
        var _this = this;
        var expandPanelCallback = function() {
          window.setTimeout(function() {
            _this._initCustomScrollbar(this.metadataPanelContent);
            _this.metadataPanel.classList.add('expanded');
            _this.metadataPanelContent.classList.add('expanded');
          }, 300); /* Timeout to let time for informations to load */
        };

        /* Show notification */
        this.fire('longActionStartEvent', {
          message: this._localize('loading', this.lang) + '...'
        });

        /* If already expanded, collapse then expand with the new values */
        if([].slice.call(this.metadataPanel.classList).indexOf('expanded') >= 0) {
          this._collapseMetadataPanel();

          window.setTimeout(function() {
            _this._setMetadata(e, expandPanelCallback);
          }, 800);
        } else {
          this._setMetadata(e, expandPanelCallback);
        }

        this._getUrlParameters();

        if(!this.urlParameters.uuid) {
          window.history.replaceState({} , '', window.location.href + '#uuid:' + e.detail.id);
        } else if (this.urlParameters.uuid === e.detail.id) {
          return;
        } else {
          this._removeUrlParameters('uuid');
          window.history.replaceState({} , '', window.location.href + '#uuid:' + e.detail.id);
        }
      },

      /* Collapse the metadata panel */
      _collapseMetadataPanel: function() {
        this.metadataPanel.classList.remove('fullscreen', 'expanded');
        this.metadataPanelContent.classList.remove('expanded');
        this._isMetadataPanelExpanded = false;
        this._expandIcon = 'fa-expand';

        this._removeUrlParameters('uuid');
      },

      /* Set metadata in the corresponding panel, then execute the callback method */
      _setMetadata: function(e, callback) {
        var metadata = this.metadataPanel.querySelector('aeris-metadata');
        this._metadataObject = e.detail;
        metadata.setAttribute('identifier', e.detail.id);

        this._metadataTitle = e.detail.title;
        var type = e.detail.type;

        metadata.refresh();

        if(callback) callback();

        /* Hide notification */
        this.fire('longActionStopEvent', {
          message: this._localize('loading', this.lang) + '...'
        });

        /* Expand metadata panel */
        this.fire('metadataPanelExpanded', e.detail);
      },

      /* Toggle fullscreen for the application */
      _toggleFullScreen: function() {
        if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement) {
          if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
          } else if (document.documentElement.mozRequestFullScreen) {
            document.documentElement.mozRequestFullScreen();
          } else if (document.documentElement.webkitRequestFullscreen) {
            document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
          }
        } else {
          if (document.cancelFullScreen) {
            document.cancelFullScreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.webkitCancelFullScreen) {
            document.webkitCancelFullScreen();
          }
        }
      },

      /* Toggle fullscreen for the metadata panel */
      _setMetadataPanelFullscreen: function() {
        this.metadataPanel.classList.toggle('fullscreen');
        this._initCustomScrollbar(this.metadataPanel);
        this._expandIcon = ([].slice.call(this.metadataPanel.classList).indexOf('fullscreen') >= 0) ? 'fa-compress' : 'fa-expand';
      },

      /* Open a new window with metadatas formatted for print */
      _printMetadatas: function() {
        var metadata = this.metadataPanel.querySelector('aeris-metadata');
        var id = metadata.getAttribute('identifier');
        var url = 'printSheet.html?url=' + this.metadataIdService + id + '&locale=' + this.lang;
        window.open(url,'_blank','toolbar=no, status=no, scrollbars=no, menubar=no, width=1000, height=800');
      },

      /* Show the JSON response inside http://jsonviewer.stack.hu */
      _showJson: function() {
        var baseUrl = 'http://www.jsoneditoronline.org/?url=';
        var url = baseUrl + this.metadataJsonUrl;
        window.open(url,'_blank','toolbar=no, status=no, scrollbars=no, menubar=no, width=1000, height=800');
      },

      _showHelp: function() {
        var searchButton = '<div style="display:inline-flex;justify-content:center;align-items:center;width:50px;height:50px;margin-top:10px;font-size:18px;border:2px solid;border-radius:50%;color:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.3);background-color:#f39c12;"><i class="fa fa-search"></i></div>';

        swal({
          title: this._localize('help', this.lang),
          text: this._localize('helpMessage', this.lang) + '<br>' + searchButton,
          html: true
        });
      },

      /* Handle cart checkout */
      _orderData: function(e) {
        var _this = this;

        swal({
          title: _this._localize('validateOrder', _this.lang),
          type: 'info',
          showCancelButton: true,
          confirmButtonText: _this._localize('ok', _this.lang),
          cancelButtonText: _this._localize('cancel', _this.lang),
          closeOnConfirm: false,
          showLoaderOnConfirm: true,
        },
        function(){
          var obj = {
            items: e.detail
          };

          _this.$.ajax.method = 'POST';
          _this.$.ajax.url = _this.metadataService + '/download';
          _this.$.ajax.body = JSON.stringify(obj);
          _this.$.ajax.generateRequest();
        });
      },

      /* Run if cart checkout is successfull */
      _handleResponse: function(request) {
        var _this = this;
        swal({
          title: _this._localize('success', _this.lang),
          text: request.detail.response,
          type: 'success',
          allowOutsideClick: true
        });

        _this.fire('cleanCart');
      },

      /* Run if there's an error with cart checkout */
      _handleError: function(request) {
        var _this = this;
        swal({
          title: _this._localize('error_occured', _this.lang),
          text: request.detail.request.statusText,
          type: 'error',
          allowOutsideClick: true,
          timer: 5000
        });
      }

    });
  </script>
  
</dom-module>