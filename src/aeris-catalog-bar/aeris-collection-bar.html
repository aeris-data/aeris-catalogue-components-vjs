<link rel="import" href="../aeris-catalog-box/aeris-catalog-box.html">
<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../../../iron-ajax/iron-ajax.html">
<link rel="import" href="../../../aeris-commons-components/dist/aeris-spinner/aeris-spinner.html">
<link rel="import" href="../../../aeris-metadata-components/dist/aeris-metadata-international-field/aeris-metadata-international-field.html">
<link rel="import" href="../../../aeris-commons-components/dist/imports/custom-scrollbar.html">
<link rel="import" href="../styles/catalog-shared-styles.html">

<dom-module id="aeris-collection-bar">

<style include="catalog-shared-styles">
    :host {
        box-sizing: border-box;
        display: block;
        width: var(--collection-bar-width, 300px);
        height: var(--collection-bar-height, 100%);
        padding: var(--collection-bar-padding, 10px);
        background-color: var(--collection-bar-background-color);
        transform: translate3d(100%, 0, 0)
    }
    :host.visible {
        transform: translate3d(0, 0, 0)
    }
    .collection-bar {
        position: relative;
        height: 100%;
        width: 100%;
        padding-top: 5px
    }
    .icon-input {
        height: 30px;
        width: calc(100% - 20px);
        margin: 5px auto;
        font-size: 16px;
        color: var(--collection-bar-filter-color);
        background-color: #fff
    }
    .icon-input input {
        background-color: transparent
    }
</style>

  <template>
    <div id="collectionBar" class="collection-bar">
      <div class="icon-input">
        <input class="filter-field" type="text" name="resultFilter" value="{{_resultFilter::input}}" placeholder="[[_localize('filter', lang)]]">
        <i class="fa fa-filter"></i>
      </div>
	    <template id="resultList" is="dom-repeat" items="[[_summaries]]" filter="{{_computeFilter(_resultFilter)}}">
	      <aeris-catalog-box title="[[item.title]]" platform="[[item.plateformType]]" ref="[[item]]" expand-message="[[_localize('more', lang)]]" on-mouseenter="_mouseEnterBox" on-mouseleave="_mouseLeaveBox" expandable closeable>
          <p><aeris-metadata-international-field value="[[_truncate(item.description)]]" lang="[[lang]]" no-label-float></aeris-metadata-international-field></p>
        </aeris-catalog-box>
	    </template>
		</div>
  </template>

  <script>

    var DESCRIPTION_LENGTH = 200;

    Polymer({

      is: 'aeris-collection-bar',

      behaviors: [LocalizeBehavior],

      properties: {
        lang: {type: String, reflectToAttribute: true},
        deployed: {type: Boolean, value: true, reflectToAttribute: true}
      },

      ready: function() {
        var el = document.querySelector('aeris-catalog-app');
        var parentLang = el.getAttribute('lang');
        this.lang = parentLang || navigator.language.substr(0, 2);

        document.addEventListener('searchBarResetEvent', this._handleSearchBarResetEvent.bind(this));
        document.addEventListener('searchBarSearchEvent', this._handleSearchBarSearchEvent.bind(this));
        document.addEventListener('searchResultEvent', this._handleSearchResultEvent.bind(this));
      },

      /* Truncate collection description and add ellipsis */
      _truncate: function(str) {
        if(!str) return '';
        str = str[this.lang];
        if(str) {
          return (str.length > DESCRIPTION_LENGTH) ? str.substring(0, DESCRIPTION_LENGTH) + '...' : str;
        } else {
          return '';
        }
        
      },

      /* Extract id from the description */
      extractId: function(desc) {
        var ind1 = desc.indexOf('(') + 1;
        var ind2 = desc.indexOf(')');
        id = desc.substring(ind1, ind2);
        return id;
      },

      _handleSearchBarResetEvent: function() {
        this.classList.remove('visible');

        window.setTimeout(function() {
          this._summaries = [];
        }, 600);

      },

      _handleSearchBarSearchEvent: function() {
        this.classList.remove('visible');
        this._summaries = [];
      },

      _deployBar : function() {
        this.classList.add('visible');
        var filterField = Polymer.dom(this.root).querySelector('.filter-field');

        window.setTimeout(function() {
          filterField.focus();
        }, 600);
      },

      _handleSearchResultEvent: function(e) {
        this._summaries = e.detail.summaries;

        Ps.destroy(this);

        Ps.initialize(this, {
          suppressScrollX: true
        });

        window.setTimeout(function() {
          this.scrollTop = 100;
          this.scrollTop = 0;
        }.bind(this), 1000);

        this._deployBar();
      },

      _computeFilter: function(string) {
        _this = this;
        if (!string) {
          // set filter to null to disable filtering
          return null;
        } else {
          // return a filter function for the current search string
          string = string.toLowerCase();
          return function(item) {
            if(!item.title[_this.lang]) return;
            var title = item.title[_this.lang].toLowerCase();
            return (title.indexOf(string) !== -1);
          };
        }
      },

      _mouseEnterBox: function(e) {
        var data = e.model.item.spatialExtents || [];
        this.fire('mapAddPreviewRequest', data);
      },

      _mouseLeaveBox: function(e) {
        this.fire('mapClearPreviewRequest');
      }

    });
  </script>

</dom-module>
