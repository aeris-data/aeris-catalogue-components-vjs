<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../../../aeris-commons-components/dist/aeris-cartouche/aeris-cartouche.html">
<link rel="import" href="../../../aeris-commons-components/dist/behaviors/i18n/localizeBehavior.html">
<link rel="import" href="../styles/catalog-shared-styles.html">

<dom-module id="keyword-search-criteria">

  <style include="catalog-shared-styles">
    :host {
        display: block
    }
    :host .program {
        margin-bottom: 5px
    }
    :host .program .program-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 5px
    }
    :host .program .program-header label {
        display: inline-flex;
        justify-content: flex-start;
        align-items: center;
        margin: 2px
    }
    :host .program .program-header .fa {
        cursor: pointer
    }
    :host .collection {
        margin-left: 20px
    }
    :host .icon-input {
        height: 20px;
        line-height: 20px;
        font-size: 14px;
        width: 100%;
        margin-bottom: 10px;
        color: #999
    }
</style>

  <template>
    <aeris-catalog-box id="box" title="[[_localize('keywords', lang)]]" platform="fa fa-terminal">
      <div class="icon-input">
        <input type="text" name="keywords" placeholder="[[_localize('keywords', lang)]]" on-input="_inputKeyword" on-keypress="_inputKeyword">
      </div>
      <template is="dom-repeat" items="[[_keywords]]">
        <aeris-cartouche rel="[[item]]" edit>[[item]]</aeris-cartouche>
      </template>
    </aeris-catalog-box>

  </template>

  <script>
    Polymer({

      is: 'keyword-search-criteria',

      behaviors: [LocalizeBehavior],

      properties: {
        lang: {type: String, reflectToAttribute: true, observer: '_update'},
        deployed: {type: Boolean, value: true, reflectToAttribute: true},
        _keywords: Array
      },

      ready: function() {
        document.addEventListener('searchBarResetEvent', this._handleSearchBarResetEvent.bind(this));
        document.addEventListener('searchBarSearchEvent', this._handleSearchBarSearchEvent.bind(this));
        this.addEventListener('itemDeleted', this._removeKeyword.bind(this));
      },

      attached: function() {
        this._update();
      },

      _update: function() {
        var el = document.querySelector('aeris-catalog-app');
        var parentLang = el.getAttribute('lang');
        this.lang = parentLang || navigator.language.substr(0, 2);
      },

      _inputKeyword: function(e) {
        var withComma = e.target.value.trim();
        if(withComma.length < 2) return;
        var keyCode = e.keyCode ? e.keyCode : e.charCode;
        
        if(withComma.endsWith(',') || keyCode === 13 || keyCode === 32) {
          var withoutComma = (withComma.endsWith(',')) ? withComma.substring(0, (withComma.length - 1)) : withComma;
          if(!this._keywords) this._keywords = [];
          this.push('_keywords', withoutComma);
          e.target.value = '';
          if(e.preventDefault) e.preventDefault();
          return false;
        }
      },

      _removeKeyword: function(e) {
        var ind = this._keywords.indexOf(e.target.rel);
        this.splice('_keywords', ind, 1);
      },

      _handleSearchBarSearchEvent: function(e) {
        var ev = {
          target: Polymer.dom(this.root).querySelector('input'),
          keyCode: 13
        }
        this._inputKeyword(ev);
        e.detail.keywords = this._keywords;
      },

      _handleSearchBarResetEvent: function() {
        this._keywords = [];
        var el = Polymer.dom(this.root).querySelector('input');
        el.value = '';
      }

    });
  </script>

</dom-module>
